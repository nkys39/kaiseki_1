# システムアーキテクチャ

## 1. 全体構成図

```
┌──────────────────────────────────────────────────────────────────────┐
│                         Kinden SLAM System                            │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │
│  │    iPad     │───▶│  Pipe_Comm  │───▶│    main     │              │
│  │  (コマンド)   │    │ (名前付きパイプ) │    │  (メイン制御) │              │
│  └─────────────┘    └─────────────┘    └──────┬──────┘              │
│                                               │                       │
│  ┌────────────────────────────────────────────┴───────────────────┐  │
│  │                        処理レイヤ                               │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │  SLAM   │  │Controller│  │Localiz. │  │PathPlan │           │  │
│  │  │自己位置推定│  │ 行動制御  │  │初期位置推定│  │ 経路計画  │           │  │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘           │  │
│  │       │           │           │           │                    │  │
│  │  ┌────┴───────────┴───────────┴───────────┴─────┐             │  │
│  │  │              共通ライブラリ                    │             │  │
│  │  │  random | multi_resolution | malloc | draw  │             │  │
│  │  └──────────────────────────────────────────────┘             │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │                      センサ/通信レイヤ                          │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │ Serial  │  │ sensing │  │illuminance│ │myRSLidar│           │  │
│  │  │シリアル通信│  │センサ処理 │  │ 照度計   │  │RS-LiDAR │           │  │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘           │  │
│  └───────┼───────────┼───────────┼───────────┼────────────────────┘  │
│          │           │           │           │                       │
└──────────┼───────────┼───────────┼───────────┼───────────────────────┘
           │           │           │           │
    ┌──────┴────┐ ┌────┴────┐ ┌────┴────┐ ┌────┴────┐
    │   Motor   │ │ Sensor  │ │   T-10A │ │RS-LiDAR │
    │  Arduino  │ │ Arduino │ │  照度計  │ │   -16   │
    └───────────┘ └─────────┘ └─────────┘ └─────────┘
         │            │            │            │
    ┌────┴────┐  ┌────┴────┐  ┌────┴────┐  ┌────┴────┐
    │左右モータ │  │バンパー  │  │  照度   │  │ 3D距離 │
    │         │  │落下センサ │  │  測定   │  │  測定  │
    └─────────┘  └─────────┘  └─────────┘  └─────────┘
```

---

## 2. 処理フローチャート

```
                    ┌─────────────┐
                    │   開始      │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │ 設定読み込み  │
                    │ (ini_Read)  │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │ センサ初期化  │
                    │ LRF/Arduino │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │  地図読み込み │
                    │  (CAD/Edge) │
                    └──────┬──────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
    ┌─────▼─────┐   ┌─────▼─────┐   ┌─────▼─────┐
    │センサスレッド│   │LiDARスレッド│   │メインスレッド│
    │(sensing)  │   │(myRSLidar)│   │  (SLAM)   │
    └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
          │                │                │
          │                │                │
          └────────────────┼────────────────┘
                           │
                    ┌──────▼──────┐
                    │ 初期位置推定  │
                    │(localization)│
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │  経路計画    │
                    │(pathplanning)│
                    └──────┬──────┘
                           │
          ┌────────────────┼────────────────┐
          │                                  │
    ┌─────▼─────┐                     ┌─────▼─────┐
    │   SLAM    │                     │  照度測定  │
    │ 自己位置推定│◀───────────────────│ illuminance │
    └─────┬─────┘     測定完了         └─────┬─────┘
          │                                  │
    ┌─────▼─────┐                            │
    │ 行動決定   │                            │
    │(controller)│                            │
    └─────┬─────┘                            │
          │                                  │
    ┌─────▼─────┐                            │
    │ モータ制御 │───────────────────────────┘
    │  (Serial) │      次の測定点へ
    └─────┬─────┘
          │
    ┌─────▼─────┐   いいえ
    │ 全点完了?  │─────────┐
    └─────┬─────┘         │
          │ はい          │
    ┌─────▼─────┐         │
    │ メール通知  │         │
    │(sendMail)  │         │
    └─────┬─────┘         │
          │               │
    ┌─────▼─────┐         │
    │   終了     │◀────────┘
    └───────────┘
```

---

## 3. SLAMアルゴリズムフロー

```
┌─────────────────────────────────────────────────────────────┐
│                      SLAMメインループ                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌───────────────┐                                          │
│  │ LRFデータ取得  │                                          │
│  └───────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│  ┌───────────────┐                                          │
│  │ 座標変換      │  極座標 → 直交座標                        │
│  │ x = d*sin(θ) │                                          │
│  │ y = d*cos(θ) │                                          │
│  └───────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                  遺伝的アルゴリズム                     │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │ 初期化 (mga_init)                               │  │  │
│  │  │  ├─ 個体0: 前回最良解                            │  │  │
│  │  │  ├─ 個体1: 原点                                  │  │  │
│  │  │  ├─ 個体2: 反転解                                │  │  │
│  │  │  └─ 個体3-29: ロボットモデル + ランダム           │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │                       │                                │  │
│  │                       ▼                                │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │ 世代ループ (T2=600回)                            │  │  │
│  │  │  ┌───────────────────────────────────────────┐  │  │  │
│  │  │  │ 1. 最良・最悪個体選択                      │  │  │  │
│  │  │  │    g_max(), g_min()                       │  │  │  │
│  │  │  └───────────────────────────────────────────┘  │  │  │
│  │  │                    │                             │  │  │
│  │  │                    ▼                             │  │  │
│  │  │  ┌───────────────────────────────────────────┐  │  │  │
│  │  │  │ 2. 交叉                                    │  │  │  │
│  │  │  │    70%: 最良遺伝子コピー                   │  │  │  │
│  │  │  │    30%: ブレンド交叉                       │  │  │  │
│  │  │  └───────────────────────────────────────────┘  │  │  │
│  │  │                    │                             │  │  │
│  │  │                    ▼                             │  │  │
│  │  │  ┌───────────────────────────────────────────┐  │  │  │
│  │  │  │ 3. 突然変異                                │  │  │  │
│  │  │  │    70%: 小変動 rndn_10()                  │  │  │  │
│  │  │  │    30%: 大変動 rndn()*rndn()              │  │  │  │
│  │  │  └───────────────────────────────────────────┘  │  │  │
│  │  │                    │                             │  │  │
│  │  │                    ▼                             │  │  │
│  │  │  ┌───────────────────────────────────────────┐  │  │  │
│  │  │  │ 4. 適合度評価 (fitcal_m)                   │  │  │  │
│  │  │  │    最悪個体を新個体で置換                  │  │  │  │
│  │  │  └───────────────────────────────────────────┘  │  │  │
│  │  └──────────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────┘  │
│          │                                                   │
│          ▼                                                   │
│  ┌───────────────┐                                          │
│  │ 位置更新      │                                          │
│  │ real += Δ    │                                          │
│  │ angle += Δθ │                                          │
│  │ map = 座標変換│                                          │
│  └───────┬───────┘                                          │
│          │                                                   │
│          ▼                                                   │
│  ┌───────────────┐                                          │
│  │ 地図更新      │  map_building2()                         │
│  │ (占有確率更新) │                                          │
│  └───────────────┘                                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. コントローラフロー

```
┌─────────────────────────────────────────────────────────────┐
│                    decision_making()                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 入力計算                                               │  │
│  │  ┌───────────────┐    ┌───────────────┐              │  │
│  │  │ 目標距離計算  │    │ 障害物距離計算 │              │  │
│  │  │ det = √(Δx²+Δy²)│  │ min_dis[5]   │              │  │
│  │  └───────┬───────┘    └───────┬───────┘              │  │
│  │          │                    │                       │  │
│  │          ▼                    ▼                       │  │
│  │  ┌───────────────┐    ┌───────────────┐              │  │
│  │  │ 目標角度計算  │    │ 5エリア分割   │              │  │
│  │  │ t_theta       │    │ 左/左前/中央/ │              │  │
│  │  │ = atan2(...) │    │ 右前/右       │              │  │
│  │  └───────────────┘    └───────────────┘              │  │
│  └───────────────────────────────────────────────────────┘  │
│                    │                    │                    │
│                    ▼                    ▼                    │
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │ 目標追従ファジィ推論  │  │ 障害物回避ファジィ推論│          │
│  │   fuzzyinf3()       │  │   fuzzyinf()        │          │
│  │                     │  │                     │          │
│  │ ・8ルール適用        │  │ ・16ルール適用       │          │
│  │ ・メンバーシップ関数 │  │ ・ランダム回避方向  │          │
│  │   ガウス型          │  │                     │          │
│  └──────────┬──────────┘  └──────────┬──────────┘          │
│             │                        │                       │
│             └───────────┬────────────┘                       │
│                         │                                    │
│                         ▼                                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 多目的行動調停                                         │  │
│  │                                                        │  │
│  │  ┌───────────────────────────────────────────────┐    │  │
│  │  │ 環境知覚情報計算                               │    │  │
│  │  │  si[0] = exp(-(障害物距離正規化 - 1)² × 4)    │    │  │
│  │  │  si[1] = 1 - si[0]                            │    │  │
│  │  └───────────────────────────────────────────────┘    │  │
│  │                         │                              │  │
│  │                         ▼                              │  │
│  │  ┌───────────────────────────────────────────────┐    │  │
│  │  │ 重み更新                                       │    │  │
│  │  │  wgt += dw × si                               │    │  │
│  │  │  wgt /= Σwgt (正規化)                         │    │  │
│  │  └───────────────────────────────────────────────┘    │  │
│  │                         │                              │  │
│  │                         ▼                              │  │
│  │  ┌───────────────────────────────────────────────┐    │  │
│  │  │ 最終出力計算                                   │    │  │
│  │  │  outp = Σ(wgt × toutp) / Σwgt                │    │  │
│  │  │  outp *= (min_dis / MAX_DIS) × maxSpeed      │    │  │
│  │  └───────────────────────────────────────────────┘    │  │
│  └───────────────────────────────────────────────────────┘  │
│                         │                                    │
│                         ▼                                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 出力: foutp[0] (右輪速度), foutp[1] (左輪速度)        │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 通信アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                       通信レイヤ                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  シリアル通信                        │    │
│  │                                                      │    │
│  │   COM3          COM4          COM5/6        COM7    │    │
│  │  ┌─────┐      ┌─────┐       ┌─────┐      ┌─────┐   │    │
│  │  │Motor│      │Sensor│      │Illum│      │ LRF │   │    │
│  │  │Ardno│      │Ardno │      │T-10A│      │UTM30│   │    │
│  │  └──┬──┘      └──┬──┘       └──┬──┘      └──┬──┘   │    │
│  │     │            │             │            │       │    │
│  │  115200bps    38400bps      4800bps     115200bps  │    │
│  │     │            │             │            │       │    │
│  │  ┌──┴────────────┴─────────────┴────────────┴──┐   │    │
│  │  │              Serial.cpp                      │   │    │
│  │  └─────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                 ネットワーク通信                     │    │
│  │                                                      │    │
│  │  ┌───────────┐   ┌───────────┐   ┌───────────┐      │    │
│  │  │   UDP     │   │   TCP     │   │   SMTP    │      │    │
│  │  │ Port:6699 │   │ Port:5000 │   │ Port:587  │      │    │
│  │  └─────┬─────┘   └─────┬─────┘   └─────┬─────┘      │    │
│  │        │               │               │             │    │
│  │  RS-LiDAR-16      iPad通信         メール通知        │    │
│  │  (myRSLidar)     (Pipe_Comm)      (quickmail)       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                 プロセス間通信                       │    │
│  │                                                      │    │
│  │  ┌───────────────────────────────────────────────┐  │    │
│  │  │         名前付きパイプ                         │  │    │
│  │  │   \\.\pipe\KINDEN_ILLM                        │  │    │
│  │  │                                               │  │    │
│  │  │   iPad ←→ main.cpp                           │  │    │
│  │  │   コマンド送受信                               │  │    │
│  │  └───────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. データ構造関係図

```
┌─────────────────────────────────────────────────────────────┐
│                      データ構造関係図                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   robot_position                       │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │ 位置情報                                        │  │  │
│  │  │  ├─ map_x, map_y      : マップ座標 [pixel]     │  │  │
│  │  │  ├─ real_x, real_y    : 実座標 [mm]            │  │  │
│  │  │  ├─ rangle, dangle    : 角度 [degree]          │  │  │
│  │  │  └─ model[3]          : ロボットモデル出力      │  │  │
│  │  ├─────────────────────────────────────────────────┤  │  │
│  │  │ GA用変数                                        │  │  │
│  │  │  ├─ gen_m[31][4]      : 遺伝子群               │  │  │
│  │  │  ├─ fit_m[31]         : 適合度                 │  │  │
│  │  │  ├─ best_gene         : 最良個体インデックス    │  │  │
│  │  │  └─ slam_count        : SLAMステップ           │  │  │
│  │  ├─────────────────────────────────────────────────┤  │  │
│  │  │ 初期位置推定用                                   │  │  │
│  │  │  ├─ gen_s[301][4]     : スケール用遺伝子        │  │  │
│  │  │  └─ fit_s[301]        : スケール適合度          │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
│                           │                                  │
│                           │ uses                             │
│                           ▼                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                     org_map                            │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │ map, map2          : SLAMマップ (占有確率)       │  │  │
│  │  │ cad_map, cad_map2  : CAD図面マップ              │  │  │
│  │  │ edge_map, edge_map2: エッジマップ               │  │  │
│  │  │ width, height      : マップサイズ               │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
│                           │                                  │
│                           │ has                              │
│                           ▼                                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                    multi_map                           │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │ mmap      : 占有マップ                          │  │  │
│  │  │ amap      : 累積マップ                          │  │  │
│  │  │ norm      : 正規化マップ (-1.0 ~ 1.0)           │  │  │
│  │  │ anorm     : 正規化累積マップ                    │  │  │
│  │  │ reso      : 解像度レベル (1, 2, 4, 8)           │  │  │
│  │  │ rate      : スケール率                          │  │  │
│  │  │ parent    : 上位解像度マップへのポインタ         │  │  │
│  │  │ child     : 下位解像度マップへのポインタ         │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │                                                        │  │
│  │  multi_map (reso=1)                                   │  │
│  │       ↑ parent                                        │  │
│  │  multi_map (reso=2)                                   │  │
│  │       ↑ parent                                        │  │
│  │  multi_map (reso=4)                                   │  │
│  │       ↑ parent                                        │  │
│  │  multi_map (reso=8)                                   │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                     es_gene                            │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │ gene[1000][4]  : 初期位置推定用個体群           │  │  │
│  │  │ es_fit[1000]   : 適合度                         │  │  │
│  │  │ es_wei[1000]   : 選択確率                       │  │  │
│  │  │ best_gene      : 最良個体                       │  │  │
│  │  │ init_pos[3]    : 初期位置 (x, y, θ)            │  │  │
│  │  │ lo_count       : 推定カウント                   │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```
